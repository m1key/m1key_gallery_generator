#!/usr/bin/env ruby

require 'm1key_gallery_generator'
require 'erb'
require 'htmlentities'

Encoding.default_external = Encoding::UTF_8

include GalleryGenerator

OUTPUT_FILE = 'index.html'
DEFAULT_GALLERY_CONFIG_FILE = 'gallery.yaml'

puts "M1key.me Gallery Generator #{M1keyGalleryGenerator::VERSION}"
puts 'www.m1key.me'
puts 'This generates a m1key.me style gallery HTML code.'
puts

working_directory = if ARGV.empty?
  Dir.pwd.tap { |dir| puts "Working directory not specified. Using [#{dir}]." }
else
  ARGV[0].tap { |dir| puts "Using working directory [#{dir}]." }
end

puts

begin
  gallery_config = GalleryConfig.new(File.join(working_directory, DEFAULT_GALLERY_CONFIG_FILE))
  viewable_photos = photos_config_into_viewable_photos(working_directory, gallery_config)

  puts 'Creating viewable gallery...'

  gallery = ViewableGallery.new(gallery_config.title, gallery_config.description, gallery_config.slug,
    gallery_config.sources, gallery_config.upload_date, gallery_config.map_url, gallery_config.map_title,
    gallery_config.year, viewable_photos, gallery_config.small_print, gallery_config.blurb, gallery_config.genre).
      update_using(
      add_tabs_before_every_description_line(3),
      add_links_to_descriptions,
      for_each_photo(&add_links_to_descriptions),
      for_each_photo(&remove_final_empty_line_from_description))

  puts 'Preparing to write the output...'

  output_file = File.join(working_directory, OUTPUT_FILE)
  puts "Writing gallery file #{output_file}..."
  template_file = File.read("#{File.dirname(File.expand_path(__FILE__))}/../lib/m1key_gallery_generator/template.erb")
  erb = ERB.new(template_file, trim_mode: '-')
  File.write(output_file, erb.result(gallery.get_binding))

  puts "#{output_file} written."

rescue StandardError => e
  puts e
  if ARGV.length > 1 && ARGV[1] == 'wait_on_error'
    require 'io/console'
    STDIN.getch
  end
end
